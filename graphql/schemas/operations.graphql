# AuthFlow

# Getting requestChallenge for startSession Query
query RequestChallenge {
  auth_challenge
}

mutation StartSession($authPubKey: String!, $challenge: String!, $signedAuthPubKey: String!, $walletPubKey: String!, $challengeSignature: String!) {
  start_session_v2(
    authPubKey: $authPubKey
    challenge: $challenge
    challengeSignature: $challengeSignature
    challengeSignatureType: SECP256K1
    signedAuthPubKey: $signedAuthPubKey
    walletPubKey: $walletPubKey
  ) {
    accessToken
    refreshToken
    walletPubKeyId
  }
}

mutation RefreshSession($refreshToken: String!) {
  refresh_session(refreshToken: $refreshToken) {
    accessToken
    refreshToken
  }
}

query PrepareWalletSession($challenge: String!, $signedChallenge: String!, $walletPubKeyId: String!) {
  prepare_wallet_session(challenge: $challenge, ownerPubKeyId: $walletPubKeyId, signature: $signedChallenge)
}

mutation UnlockWallet($challenge: String!, $challengeSignature: String!, $preparedPermissionToken: String!) {
  start_prepared_session(challenge: $challenge, challengeSignature: $challengeSignature, preparedPermissionToken: $preparedPermissionToken, challengeSignatureType: SECP256K1) {
    accessToken
    refreshToken
  }
}

mutation AcceptTermsAndConditions($pubKeyId: uuid) {
  accept_terms(args: {pubkey_id: $pubKeyId}) {
    acceptedTerms
  }
}

mutation AcceptCustomTermsAndConditions($serviceProvider: String!) {
  accept_terms_conditions(args: {service_provider: $serviceProvider}) {
    serviceProvider
    acceptedTerms
    acceptDate
  }
}

# Employee

query GetBusinessOwner($ownerWalletPubKeyId: uuid!) {
  wallet_acl(where: {memberWalletPubKeyId: {_eq: $ownerWalletPubKeyId}}) {
    accessExpiresAt
    ownerWalletPubKeyId
  }
}

# Currency

query GetExchangeRate($code: String!) {
  currency(where: {currencyCode: {_eq: $code }}) {
    currencyCode
    satsPerUnit
  }
}

query GetAllExchangeRates {
  currency {
    currencyCode
    satsPerUnit
    conversionRateUpdatedAt
  }
}


query ListCurrencyCodes {
  currency(order_by: {currencyCode: asc}) {
    currencyCode
  }
}

# [mole] Channel state persistence

mutation InsertChannelMonitorOne($channelId: bytea!, $encryptedChannelMonitor: bytea!, $installationId: String!, $encryptedDeviceInfo: bytea!) {
  insert_channel_monitor_one(object: {
        channelId: $channelId,
        encryptedChannelMonitor: $encryptedChannelMonitor,
        installationId: $installationId,
        encryptedDeviceInfo: $encryptedDeviceInfo,
    }) {
      channelId
  }
}

query GetChannelMonitorChannelIds {
  channel_monitor(distinct_on: channelId, order_by: {channelId: desc}) {
    channelId
  }
}

query GetLatestChannelMonitor($channelId: bytea!) {
  channel_monitor(order_by: {timestamp: desc}, where: {channelId: {_eq: $channelId}}, limit: 1) {
    encryptedChannelMonitor
  }
}

mutation InsertChannelManagerOne($encryptedChannelManager: bytea!) {
  insert_channel_manager_one(object: {
        encryptedChannelManager: $encryptedChannelManager,
    }) {
      walletId
  }
}

query GetLatestChannelManager {
  channel_manager(order_by: {timestamp: desc}, limit: 1) {
      encryptedChannelManager,
  }
}

# topups

mutation RegisterTopup($orderId: String!, $email: String){
  register_topup(orderId: $orderId, email: $email) {
    walletPubKeyId,
    nodePubKey,
    email,
  }
}

mutation RegisterNotificationToken($language: String!, $notificationToken: String!) {
  register_notification_token(language: $language, notificationToken: $notificationToken) {
    id
  }
}

mutation HideTopup($id: String!) {
  hide_topup(id: $id)
}

query ListUncompletedTopups {
  topup(where: {_or: [{status: {_eq: READY}}, {status: {_eq: FAILED}}, {status: {_eq: REFUNDED}}]}) {
    additionalInfo
    amountSat
    amountUserCurrency
    createdAt
    exchangeFeeRate
    exchangeFeeUserCurrency
    exchangeRate
    expiresAt
    id
    lightningFeeUserCurrency
    lnurl
    nodePubKey
    status
    userCurrency
  }
}

query MigrationBalance($nodePubKey: String) {
  migration_balance(nodePubKey: $nodePubKey) {
	balanceAmountSat
  }
}

mutation MigrateFunds($invoice: String, $base16InvoiceSignature: String, $ldkNodePubKey: String) {
  migrate_funds(invoice: $invoice, base16InvoiceSignature: $base16InvoiceSignature, ldkNodePubKey: $ldkNodePubKey)
}

mutation CreateBackup($encryptedBackup: String!, $schemaName: String!, $schemaVersion: String!) {
  create_backup(encryptedBackup: $encryptedBackup, schemaName: $schemaName, schemaVersion: $schemaVersion) {
    updatedAt
  }
}

mutation RecoverBackup($schemaName: String!) {
  recover_backup(schemaName: $schemaName) {
    encryptedBackup
    schemaVersion
    updatedAt
  }
}

mutation ReportPaymentTelemetry($telemetryId: String!, $events: PaymentTelemetryEventsInput) {
  report_payment_telemetry(telemetryId: $telemetryId, events: $events) {
    payFailed
  }
}
